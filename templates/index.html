<!DOCTYPE html>
<html>
<head>
    <title>Interview Analyzer</title>
</head>
<body>

<h2>Interview Analyzer</h2>

<video id="video" width="320" height="240" autoplay></video>
<br><br>

<button onclick="startRecording()">Start</button>
<button onclick="stopRecording()">Stop</button>

<p id="status"></p>

<script>
let mediaRecorder;
let audioChunks = [];
let stream;
let autoStopTimer = null;
const MAX_RECORDING_MS = 45000;

window.onload = async () => {
    document.getElementById("status").innerText = "Initializing camera...";

    stream = await navigator.mediaDevices.getUserMedia({
        audio: true,
        video: true
    });

    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();

    document.getElementById("status").innerText = "Ready";
};

function startRecording() {
    audioChunks = [];
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
            audioChunks.push(event.data);
        }
    };

    mediaRecorder.start();
    document.getElementById("status").innerText = "Recording... Speak now";

    clearTimeout(autoStopTimer);
    autoStopTimer = setTimeout(() => {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            document.getElementById("status").innerText = "Auto-stopping to keep processing fast...";
            stopRecording();
        }
    }, MAX_RECORDING_MS);
}

function stopRecording() {
    clearTimeout(autoStopTimer);
    document.getElementById("status").innerText = "Processing...";

    if (!mediaRecorder || mediaRecorder.state !== "recording") {
        return;
    }

    mediaRecorder.stop();

    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: "video/webm" });
        const file = new File([blob], "recording.webm", { type: "video/webm" });

        const formData = new FormData();
        formData.append("video", file);

        try {
            const response = await fetch("/start_interview", {
                method: "POST",
                body: formData
            });

            const raw = await response.text();
            let payload = null;
            try {
                payload = JSON.parse(raw);
            } catch (_) {
                payload = null;
            }

            if (!response.ok) {
                const errorText = payload?.error || raw || "Unknown server error";
                document.getElementById("status").innerText = `Error: ${errorText}`;
                return;
            }

            if (!payload) {
                document.getElementById("status").innerText = `Unexpected response: ${raw}`;
                return;
            }

            document.getElementById("status").innerHTML = `
                Transcript: ${payload["Transcript"]}<br>
                Eye Contact Score: ${payload["Eye Contact Score"]}<br>
                Filler Words: ${payload["Filler Words"]}
            `;
        } catch (err) {
            document.getElementById("status").innerText = `Error: ${err.message}`;
        }

        audioChunks = [];
    };
}
</script>

</body>
</html>
